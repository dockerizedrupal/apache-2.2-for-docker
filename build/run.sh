#!/usr/bin/env bash

dnsLookup() {
  echo "$(host "${1}" | awk '/has address/ { print $4 }')"
}

if [ -z "${PHP52_PORT_9000_TCP_ADDR}" ]; then
  IP="$(dnsLookup "${PHP52_PORT_9000_TCP_ADDR}")"

  if [ ! -z "${IP}" ]; then
    PHP52_PORT_9000_TCP_ADDR="${IP}"
  fi
fi

export FACTER_PHP52_PORT_9000_TCP_ADDR="${PHP52_PORT_9000_TCP_ADDR}"
export FACTER_PHP52_PORT_9000_TCP_PORT="${PHP52_PORT_9000_TCP_PORT}"

if [ -z "${PHP52_PORT_9000_TCP}" ]; then
  PHP52_PORT_9000_TCP="tcp://${PHP52_PORT_9000_TCP_ADDR}:${PHP52_PORT_9000_TCP_PORT}"
fi

export FACTER_PHP52_PORT_9000_TCP="${PHP52_PORT_9000_TCP}"

if [ -z "${PHP53_PORT_9000_TCP_ADDR}" ]; then
  IP="$(dnsLookup "${PHP53_PORT_9000_TCP_ADDR}")"

  if [ ! -z "${IP}" ]; then
    PHP53_PORT_9000_TCP_ADDR="${IP}"
  fi
fi

export FACTER_PHP53_PORT_9000_TCP_ADDR="${PHP53_PORT_9000_TCP_ADDR}"
export FACTER_PHP53_PORT_9000_TCP_PORT="${PHP53_PORT_9000_TCP_PORT}"

if [ -z "${PHP53_PORT_9000_TCP}" ]; then
  PHP53_PORT_9000_TCP="tcp://${PHP53_PORT_9000_TCP_ADDR}:${PHP53_PORT_9000_TCP_PORT}"
fi

export FACTER_PHP53_PORT_9000_TCP="${PHP53_PORT_9000_TCP}"

if [ -z "${PHP54_PORT_9000_TCP_ADDR}" ]; then
  IP="$(dnsLookup "${PHP54_PORT_9000_TCP_ADDR}")"

  if [ ! -z "${IP}" ]; then
    PHP54_PORT_9000_TCP_ADDR="${IP}"
  fi
fi

export FACTER_PHP54_PORT_9000_TCP_ADDR="${PHP54_PORT_9000_TCP_ADDR}"
export FACTER_PHP54_PORT_9000_TCP_PORT="${PHP54_PORT_9000_TCP_PORT}"

if [ -z "${PHP54_PORT_9000_TCP}" ]; then
  PHP54_PORT_9000_TCP="tcp://${PHP54_PORT_9000_TCP_ADDR}:${PHP54_PORT_9000_TCP_PORT}"
fi

export FACTER_PHP54_PORT_9000_TCP="${PHP54_PORT_9000_TCP}"

if [ -z "${PHP55_PORT_9000_TCP_ADDR}" ]; then
  IP="$(dnsLookup "${PHP55_PORT_9000_TCP_ADDR}")"

  if [ ! -z "${IP}" ]; then
    PHP55_PORT_9000_TCP_ADDR="${IP}"
  fi
fi

export FACTER_PHP55_PORT_9000_TCP_ADDR="${PHP55_PORT_9000_TCP_ADDR}"
export FACTER_PHP55_PORT_9000_TCP_PORT="${PHP55_PORT_9000_TCP_PORT}"

if [ -z "${PHP55_PORT_9000_TCP}" ]; then
  PHP55_PORT_9000_TCP="tcp://${PHP55_PORT_9000_TCP_ADDR}:${PHP55_PORT_9000_TCP_PORT}"
fi

export FACTER_PHP55_PORT_9000_TCP="${PHP55_PORT_9000_TCP}"

if [ -z "${PHP56_PORT_9000_TCP_ADDR}" ]; then
  IP="$(dnsLookup "${PHP56_PORT_9000_TCP_ADDR}")"

  if [ ! -z "${IP}" ]; then
    PHP56_PORT_9000_TCP_ADDR="${IP}"
  fi
fi

export FACTER_PHP56_PORT_9000_TCP_ADDR="${PHP56_PORT_9000_TCP_ADDR}"
export FACTER_PHP56_PORT_9000_TCP_PORT="${PHP56_PORT_9000_TCP_PORT}"

if [ -z "${PHP56_PORT_9000_TCP}" ]; then
  PHP56_PORT_9000_TCP="tcp://${PHP56_PORT_9000_TCP_ADDR}:${PHP56_PORT_9000_TCP_PORT}"
fi

export FACTER_PHP56_PORT_9000_TCP="${PHP56_PORT_9000_TCP}"

env

puppet apply /etc/puppet/manifests/run.pp

/usr/bin/supervisord
